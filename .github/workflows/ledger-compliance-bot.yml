name: Ledger Compliance Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ledger-compliance:
    name: Check Ledger Compliance
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          echo "Fetching changed files in this PR..."
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "$CHANGED_FILES"
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for ledger-critical paths
        id: check-ledger-paths
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
          LEDGER_CRITICAL=false
          
          echo "Checking for ledger-critical path changes..."
          
          # Check for changes in ledger-critical paths
          if echo "$CHANGED_FILES" | grep -E "(^|/)src/ledger/|^app/api/ledger/|^api/ledger/" > /dev/null; then
            echo "‚úã Ledger-critical paths detected!"
            LEDGER_CRITICAL=true
          else
            echo "‚úì No ledger-critical paths affected."
          fi
          
          echo "is_ledger_critical=$LEDGER_CRITICAL" >> $GITHUB_OUTPUT

      - name: Post compliance checklist comment
        if: steps.check-ledger-paths.outputs.is_ledger_critical == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üîí Ledger Compliance Checklist

            This PR modifies **ledger-critical paths** and requires enhanced review:

            ### Required Checks
            Please ensure the following are addressed:

            - [ ] **Input Validation**: All inputs are validated and sanitized
            - [ ] **Schema Versioning**: Schema changes include proper versioning
            - [ ] **Migration Strategies**: Migration paths are documented and tested
            - [ ] **Determinism**: Operations produce deterministic outputs
            - [ ] **Test Coverage**: Tests cover all ledger-critical code paths
            - [ ] **Documentation**: Schema changes are documented

            ### Approval Requirements
            ‚ö†Ô∏è **Founder approval required** for all ledger-specific changes.

            ---
            *This checklist was automatically generated by the Ledger Compliance Bot.*`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Ledger Compliance Checklist')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Verify founder approval
        if: steps.check-ledger-paths.outputs.is_ledger_critical == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Configuration: Update this if the founder username changes
            const founder = 'TheAVCfiles';
            const prAuthor = context.payload.pull_request.user.login;
            
            // Get reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            // Check if founder approved
            const founderApproved = reviews.some(review => 
              review.user.login === founder && review.state === 'APPROVED'
            );
            
            if (!founderApproved && prAuthor !== founder) {
              core.warning(`‚ö†Ô∏è Ledger-critical PR requires approval from @${founder}`);
              // Don't fail the check, just warn - the merge gate will handle enforcement
            } else if (founderApproved) {
              core.info(`‚úì Founder approval received from @${founder}`);
            } else {
              core.info(`‚úì PR authored by founder @${founder}`);
            }
