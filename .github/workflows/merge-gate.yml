name: Merge Gatekeeper

on:
  pull_request:

jobs:
  merge-gate:
    name: Enforce Maintainer Shield
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate CI Status
        run: |
          echo "ğŸ” Checking CI status..."
          if [ "${{ github.event.pull_request.mergeable_state }}" = "dirty" ]; then
            echo "âŒ Merge blocked: PR has conflicts."
            exit 1
          fi

          STATUS="${{ github.event.pull_request.mergeable_state }}"
          if [[ "$STATUS" == "clean" || "$STATUS" == "unstable" ]]; then
            echo "âœ” CI status acceptable for merge gating."
          else
            echo "âŒ Merge blocked: CI or mergeability uncertain ($STATUS)."
            exit 1
          fi

      - name: Block TODOs in ledger-critical paths
        run: |
          echo "ğŸ” Checking for TODOs in ledger code..."
          if grep -R "TODO" ./src/ledger 2>/dev/null; then
            echo "âŒ Merge blocked: TODO found in ledger-critical code."
            exit 1
          else
            echo "âœ” No TODOs detected in src/ledger."
          fi

      - name: Verify smoke test existence
        run: |
          echo "ğŸ” Checking for CI smoke test file..."
          if [ ! -f ".github/workflows/ci-smoke.yml" ]; then
            echo "âŒ Merge blocked: CI smoke test missing."
            exit 1
          else
            echo "âœ” CI smoke test workflow present."
          fi

      - name: Final Founder Gate
        run: |
          echo "ğŸ” Ensuring PR cannot merge without explicit maintainer approval..."
          AUTHOR="${{ github.event.pull_request.user.login }}"
          MAINTAINER="TheAVCfiles"

          if [ "$AUTHOR" != "$MAINTAINER" ]; then
            echo "âš  PR opened by $AUTHOR. Maintainer ($MAINTAINER) must review and approve before merging."
          fi

          echo "ğŸ›¡ Merge Gatekeeper checks passed (preliminary)."