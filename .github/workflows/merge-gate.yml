name: Merge Gatekeeper

on:
  pull_request:

jobs:
  merge-gate:
    name: Enforce Maintainer Shield
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate CI Status
        run: |
          echo "ğŸ” Checking CI status..."
          if [ "${{ github.event.pull_request.mergeable_state }}" = "dirty" ]; then
            echo "âŒ Merge blocked: PR has conflicts."
            exit 1
          fi

          STATUS="${{ github.event.pull_request.mergeable_state }}"
          if [[ "$STATUS" == "clean" || "$STATUS" == "unstable" ]]; then
            echo "âœ” CI status acceptable for merge gating."
          else
            echo "âŒ Merge blocked: CI or mergeability uncertain ($STATUS)."
            exit 1
          fi

      - name: Block TODOs in ledger-critical paths
        run: |
          echo "ğŸ” Checking for TODOs in ledger code..."
          if grep -R "TODO" ./src/ledger 2>/dev/null; then
            echo "âŒ Merge blocked: TODO found in ledger-critical code."
            exit 1
          else
            echo "âœ” No TODOs detected in src/ledger."
          fi

      - name: Verify smoke test existence
        run: |
          echo "ğŸ” Checking for CI smoke test file..."
          if [ ! -f ".github/workflows/ci-smoke.yml" ]; then
            echo "âŒ Merge blocked: CI smoke test missing."
            exit 1
          else
            echo "âœ” CI smoke test workflow present."
          fi

      - name: Check for ledger-critical changes
        id: check-ledger
        run: |
          echo "ğŸ” Checking for ledger-critical path changes..."
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          if echo "$CHANGED_FILES" | grep -E "(^|/)src/ledger/|^app/api/ledger/|^api/ledger/" > /dev/null; then
            echo "is_ledger_critical=true" >> $GITHUB_OUTPUT
            echo "âœ‹ Ledger-critical paths detected - founder approval required"
          else
            echo "is_ledger_critical=false" >> $GITHUB_OUTPUT
            echo "âœ” No ledger-critical paths affected"
          fi

      - name: Enforce founder approval for ledger-critical PRs
        if: steps.check-ledger.outputs.is_ledger_critical == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Configuration: Update this if the founder username changes
            const founder = 'TheAVCfiles';
            const prAuthor = context.payload.pull_request.user.login;
            
            // If PR is by founder, no additional approval needed
            if (prAuthor === founder) {
              core.info(`âœ“ PR authored by founder @${founder}`);
              return;
            }
            
            // Get reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            // Check if founder approved
            const founderApproved = reviews.some(review => 
              review.user.login === founder && review.state === 'APPROVED'
            );
            
            if (!founderApproved) {
              core.setFailed(`âŒ Merge blocked: Ledger-critical PR requires approval from @${founder}`);
            } else {
              core.info(`âœ“ Founder approval received from @${founder}`);
            }

      - name: Verify Phase 2 automation labels
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const labels = pr.labels.map(l => l.name);
            const hasRiskLabel = labels.some(l => l.startsWith('risk:'));
            
            if (!hasRiskLabel) {
              core.warning('âš ï¸ No risk label found. Risk Classification workflow may not have run yet.');
            } else {
              core.info(`âœ“ Risk label present: ${labels.find(l => l.startsWith('risk:'))}`);
            }

      - name: Final Founder Gate
        run: |
          echo "ğŸ” Final maintainer approval check..."
          # Configuration: Update this if the founder/maintainer username changes
          AUTHOR="${{ github.event.pull_request.user.login }}"
          MAINTAINER="TheAVCfiles"

          if [ "$AUTHOR" != "$MAINTAINER" ]; then
            echo "âš  PR opened by $AUTHOR. Maintainer ($MAINTAINER) must review and approve before merging."
          fi

          echo "ğŸ›¡ Merge Gatekeeper checks passed."